<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>Bom Stickman Party ‚Äî By MohFahmi</title>
<style>
:root{
  --bg:#031018; --panel:rgba(15,23,32,0.86); --accent:#ffcc00; --text:#e6eef6; --muted:#9fbfe8;
  --menu-w:86%;
}
html,body{height:100%;margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Arial;color:var(--text);background:linear-gradient(180deg,#011018,#04202a);}
.app{max-width:1000px;margin:0 auto; min-height:100vh; display:flex; flex-direction:column; gap:8px; padding:8px;}
header{display:flex; align-items:center; justify-content:space-between; gap:8px;}
.hamburger{width:44px;height:44px;border-radius:10px;background:rgba(255,255,255,0.03);display:flex;align-items:center;justify-content:center;font-size:20px;cursor:pointer;border:1px solid rgba(255,255,255,0.04);}
.title{font-weight:700;font-size:16px}
/* menu */
.sideMenu{position:fixed; left:-100%; top:0; height:100vh; width:var(--menu-w); max-width:420px; background:var(--panel); box-shadow:24px 0 60px rgba(0,0,0,0.6); padding:18px; z-index:120; transition:left 260ms cubic-bezier(.2,.9,.2,1); display:flex; flex-direction:column; gap:12px;}
.sideMenu.open{left:0;}
.sideMenu h2{margin:0;font-size:18px}
.sideMenu .muted{font-size:13px;color:var(--muted)}
.sideButtons{display:flex;flex-direction:column;gap:8px;margin-top:8px;}
.btn{background:var(--accent); color:#111; border:none; padding:10px 12px; border-radius:10px; font-weight:700; cursor:pointer;}
.linkish{background:transparent;border:1px solid rgba(255,255,255,0.06); color:var(--text); padding:10px;border-radius:8px; cursor:pointer; text-align:left;}
.row{display:flex;gap:8px;align-items:center;}
.toggleBtn{display:inline-flex;align-items:center;gap:8px;padding:8px;border-radius:8px;background:rgba(255,255,255,0.02);cursor:pointer;border:1px solid rgba(255,255,255,0.04)}
.menuForm label{display:block;margin-top:8px;margin-bottom:4px;font-size:13px;color:var(--muted)}
.menuForm select,.menuForm input{width:100%;padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:var(--text)}
.overlay{position:fixed; inset:0; background:rgba(0,0,0,0.35); z-index:110; display:none;}
.overlay.show{display:block;}
/* arena */
.arenaWrap{width:100%; display:flex; flex-direction:column; gap:8px; align-items:stretch;}
.arena{background:linear-gradient(180deg,#05202b,#021018); border-radius:10px; padding:8px; box-sizing:border-box; position:relative; overflow:hidden;}
@media (max-width:720px){ .arena{height:65vh;} }
@media (min-width:721px){ .arena{height:520px;} }
canvas{width:100%; height:100%; display:block; border-radius:6px; touch-action:none;}
/* joystick */
.joystick{ position:absolute; width:92px; height:92px; border-radius:999px; background: rgba(255,255,255,0.02); display:flex; align-items:center; justify-content:center; z-index:80; touch-action:none; pointer-events:none;}
.js-base{ width:64px;height:64px;border-radius:999px;background:rgba(255,255,255,0.03); display:flex; align-items:center; justify-content:center; pointer-events:auto; box-shadow: inset 0 6px 12px rgba(0,0,0,0.35);}
.js-knob{ width:34px;height:34px;border-radius:999px;background:linear-gradient(180deg,#fff,#ddd); box-shadow:0 6px 12px rgba(0,0,0,0.35); transform: translate(0,0);}
.playerLabel{position:absolute; transform:translate(-50%,-50%); background:rgba(0,0,0,0.35); padding:4px 8px; border-radius:999px; font-weight:700; font-size:12px; top:-8px; left:50%}
/* corner classes */
.js-bl{ left:12px; bottom:12px; } .js-br{ right:12px; bottom:12px; }
.js-tl{ left:12px; top:84px; } .js-tr{ right:12px; top:84px; }
/* top/bottom center for 2 players */
.js-topcenter{ left:50%; transform:translateX(-50%); top:12px; }
.js-bottomcenter{ left:50%; transform:translateX(-50%); bottom:12px; }
/* HUD */
.hud{position:absolute; left:12px; top:12px; z-index:90;}
.status{background:rgba(0,0,0,0.36); padding:8px 10px; border-radius:8px; font-size:13px;}
.legend{position:absolute; right:10px; top:12px; z-index:90; font-size:13px;}
.sw{display:inline-block;width:14px;height:14px;border-radius:4px;margin-right:8px;vertical-align:middle;}
.underboard{background:rgba(255,255,255,0.02); padding:8px; border-radius:8px; margin-top:4px;}
.lbRow{display:flex; gap:8px; align-items:center; margin-bottom:6px;}
.lbName{font-weight:700}
.footer{display:flex;justify-content:space-between;align-items:center;margin-top:6px;color:var(--muted);font-size:13px;}
.small{font-size:13px;color:var(--muted)}
/* message bubble for gameplay messages only */
.msgBubble{position:absolute; left:50%; top:10px; transform:translateX(-50%); background:rgba(0,0,0,0.5); padding:6px 10px; border-radius:8px; z-index:95; font-weight:700; display:none;}
</style>
</head>
<body>
  <div class="app">
    <header>
      <div style="display:flex;gap:8px;align-items:center">
        <div id="hamb" class="hamburger" aria-label="menu">‚ò∞</div>
        <div class="title">Bom Stickman Party</div>
      </div>
      <div class="small">By MohFahmi</div>
    </header>

    <!-- slide menu -->
    <div id="menu" class="sideMenu" role="dialog" aria-hidden="true">
      <h2>Menu</h2>
      <div class="muted">Mulai permainan atau ubah pengaturan</div>

      <div class="sideButtons">
        <button id="startBtn" class="btn">‚ñ∂Ô∏è Start Game</button>
        <button id="openLeader" class="linkish">üèÜ Leaderboard</button>

        <div class="row" style="margin-top:4px;">
          <div id="soundToggle" class="toggleBtn" title="Suara On/Off">üîä <span id="soundLabel">Suara: On</span></div>
        </div>

        <div style="height:1px;background:rgba(255,255,255,0.03);margin:10px 0;"></div>

        <div class="menuForm">
          <label>Jumlah Pemain (total)</label>
          <select id="totalPlayers">
            <option value="2">2 Pemain</option>
            <option value="3">3 Pemain</option>
            <option value="4" selected>4 Pemain</option>
          </select>

          <label>Jumlah Pemain Manusia</label>
          <select id="humanPlayers">
            <option value="1">1 Manusia</option>
            <option value="2" selected>2 Manusia</option>
            <option value="3">3 Manusia</option>
            <option value="4">4 Manusia</option>
          </select>

          <label>Durasi Bom (detik) ‚Äî Min / Max</label>
          <div style="display:flex;gap:8px">
            <input id="minDur" type="number" value="40" min="2">
            <input id="maxDur" type="number" value="80" min="3">
          </div>

          <div style="display:flex;gap:8px;margin-top:8px;">
            <button id="preset2045" class="linkish">20-45</button>
            <button id="preset4080" class="linkish">40-80</button>
          </div>

          <label style="margin-top:8px">Mode</label>
          <select id="modeSelect">
            <option value="friends" selected>Bermain dengan Teman (Local)</option>
            <option value="bots">Only Bots</option>
          </select>

          <div style="display:flex; gap:8px; margin-top:10px;">
            <button id="applyBtn" class="btn">Apply & Start</button>
            <button id="closeMenuBtn" class="linkish">Tutup</button>
          </div>
        </div>

        <div style="margin-top:auto; font-size:12px; color:var(--muted)">Credit by MohFahmi</div>
      </div>
    </div>

    <div id="overlay" class="overlay"></div>

    <!-- arena & UI -->
    <div class="arenaWrap">
      <div class="arena" id="arena">
        <canvas id="gameCanvas"></canvas>

        <!-- HUD left -->
        <div class="hud"><div id="status" class="status">Siap ‚Äî buka menu ‚ò∞ lalu Start</div></div>

        <!-- message bubble for gameplay (only) -->
        <div id="msgBubble" class="msgBubble"></div>

        <!-- legend & joystick layer -->
        <div id="legend" class="legend"></div>
        <div id="joystickLayer" style="position:absolute; left:0; top:0; right:0; bottom:0; pointer-events:none;"></div>

        <button id="backToMenu" style="position:absolute; left:12px; top:12px; z-index:95; border-radius:10px; padding:8px; background:rgba(255,255,255,0.04); color:var(--text); border:none; display:none;">‚Üê Menu</button>
      </div>

      <div class="underboard" id="underboard">
        <h4 style="margin:0 0 6px 0">Leaderboard (Local)</h4>
        <div id="underList"></div>
        <div style="display:flex; gap:8px; margin-top:8px;">
          <button id="resetLB" class="linkish">Reset Leaderboard</button>
        </div>
      </div>
    </div>

    <div class="footer">
      <div class="small">Joystick bundar transparan ‚Äî untuk 2 pemain: atas & bawah; sentuh & drag stickman juga bisa.</div>
      <div class="small">Credit by MohFahmi</div>
    </div>
  </div>

<script>
/* Fixed version:
 - removed menu overlay in map
 - for 4 players: P1 & P3 spawn bottom (face up), P2 & P4 spawn top (face down)
 - for 2 players: P1 bottom (face up), P2 top (face down)
 - player labels drawn on canvas
 - gameplay messages remain visible via msgBubble
 - settings persist in localStorage
*/

const SETTINGS_KEY = 'bom_prefs_v3';
const LB_KEY = 'bom_leader_v3';

const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
let W = 800, H = 520;
function adaptCanvas(){
  const area = document.getElementById('arena');
  const rect = area.getBoundingClientRect();
  canvas.style.width = '100%';
  canvas.style.height = rect.height + 'px';
  const dpr = window.devicePixelRatio || 1;
  canvas.width = Math.max(640, Math.floor(rect.width * dpr));
  canvas.height = Math.max(420, Math.floor(rect.height * dpr));
  W = canvas.width; H = canvas.height;
}
window.addEventListener('resize', ()=> setTimeout(adaptCanvas,80));
setTimeout(adaptCanvas,120);

// DOM refs
const menu = document.getElementById('menu'), overlay = document.getElementById('overlay'), hamb = document.getElementById('hamb');
const startBtn = document.getElementById('startBtn'), openLeader = document.getElementById('openLeader');
const applyBtn = document.getElementById('applyBtn'), closeMenuBtn = document.getElementById('closeMenuBtn');
const backToMenu = document.getElementById('backToMenu'), statusEl = document.getElementById('status');
const legendDiv = document.getElementById('legend'), joystickLayer = document.getElementById('joystickLayer');
const underList = document.getElementById('underList'), resetLB = document.getElementById('resetLB');
const soundToggle = document.getElementById('soundToggle'), soundLabel = document.getElementById('soundLabel');
const msgBubble = document.getElementById('msgBubble');

const totalPlayersEl = document.getElementById('totalPlayers'), humanPlayersEl = document.getElementById('humanPlayers');
const minDurEl = document.getElementById('minDur'), maxDurEl = document.getElementById('maxDur'), modeSelect = document.getElementById('modeSelect');
const preset2045 = document.getElementById('preset2045'), preset4080 = document.getElementById('preset4080');
preset2045.addEventListener('click', ()=>{ minDurEl.value=20; maxDurEl.value=45; });
preset4080.addEventListener('click', ()=>{ minDurEl.value=40; maxDurEl.value=80; });

// audio & storage
const AudioCtx = window.AudioContext || window.webkitAudioContext;
const audioCtx = new AudioCtx();
let soundEnabled = true;
function loadSettings(){ try{ const raw = localStorage.getItem(SETTINGS_KEY); return raw ? JSON.parse(raw) : null; }catch(e){ return null; } }
function saveSettings(s){ try{ localStorage.setItem(SETTINGS_KEY, JSON.stringify(s)); }catch(e){} }
function loadLB(){ try{ const raw = localStorage.getItem(LB_KEY); return raw ? JSON.parse(raw) : []; }catch(e){ return []; } }
function saveLB(lb){ try{ localStorage.setItem(LB_KEY, JSON.stringify(lb)); }catch(e){} }

const saved = loadSettings();
if(saved && typeof saved.soundEnabled === 'boolean') soundEnabled = saved.soundEnabled;
function setSoundUI(){ soundLabel.textContent = `Suara: ${soundEnabled ? 'On' : 'Off'}`; soundToggle.textContent = `${soundEnabled ? 'üîä' : 'üîá'} `; soundToggle.appendChild(soundLabel); }
setSoundUI();
function playBeep(freq=600, time=0.05, type='sine'){ if(!soundEnabled) return; const t0=audioCtx.currentTime; const o=audioCtx.createOscillator(); const g=audioCtx.createGain(); o.type=type; o.frequency.value=freq; o.connect(g); g.connect(audioCtx.destination); g.gain.value=0.0001; o.start(t0); g.gain.exponentialRampToValueAtTime(0.12,t0+0.01); g.gain.exponentialRampToValueAtTime(0.0001,t0+time); o.stop(t0+time+0.02); }
function playWhoosh(){ if(!soundEnabled) return; playBeep(1200,0.08,'sawtooth'); }
function playExplosion(){ if(!soundEnabled) return; const t0=audioCtx.currentTime; const bufferSize = audioCtx.sampleRate * 0.16; const buffer = audioCtx.createBuffer(1,bufferSize,audioCtx.sampleRate); const data = buffer.getChannelData(0); for(let i=0;i<bufferSize;i++){ data[i] = (Math.random()*2-1) * Math.exp(-3*i/bufferSize); } const noise = audioCtx.createBufferSource(); noise.buffer=buffer; const ng=audioCtx.createGain(); noise.connect(ng); ng.connect(audioCtx.destination); ng.gain.value=0.0001; noise.start(t0); ng.gain.exponentialRampToValueAtTime(0.9,t0+0.01); ng.gain.exponentialRampToValueAtTime(0.0001,t0+0.22); noise.stop(t0+0.25); const o=audioCtx.createOscillator(); const og=audioCtx.createGain(); o.type='sine'; o.frequency.value=90; o.connect(og); og.connect(audioCtx.destination); og.gain.value=0.0001; o.start(t0); og.gain.exponentialRampToValueAtTime(0.8,t0+0.015); og.gain.exponentialRampToValueAtTime(0.0001,t0+0.45); o.frequency.exponentialRampToValueAtTime(40,t0+0.45); o.stop(t0+0.55); }
document.addEventListener('touchstart', function resumeAudio(){ if(audioCtx.state === 'suspended') audioCtx.resume(); document.removeEventListener('touchstart', resumeAudio); });
soundToggle.addEventListener('click', ()=>{ soundEnabled = !soundEnabled; setSoundUI(); const s = loadSettings() || {}; s.soundEnabled = soundEnabled; saveSettings(s); });

// game state
let players = [], joysticks = [];
let totalPlayers = parseInt(totalPlayersEl.value,10), humanPlayers = Math.min(totalPlayers, parseInt(humanPlayersEl.value,10));
let running = false, bomb = null, projectiles = [], particles = [];
const colors = ['#57C7FF','#FFB86B','#A3FF8A','#FF6B9A'];
function rand(min,max){ return Math.random()*(max-min)+min; }
function dist(a,b){ return Math.hypot(a.x-b.x, a.y-b.y); }
function easeOutCubic(t){ return (--t)*t*t+1; }

/* SPAWN RULES:
 - 2 players: P1 bottom, P2 top
 - 4 players: P1 bottom-left, P2 top-left, P3 bottom-right, P4 top-right
 - 3 players: place P1 bottom-left, P2 top-center, P3 bottom-right (kepraktisan)
*/
function spawnPlayers(total, humans){
  adaptCanvas();
  players = [];
  if(total === 2){
    const topY = 0.18 * H; const botY = 0.82 * H; const centerX = 0.5 * W;
    for(let i=0;i<2;i++){
      const isBot = (i >= humans);
      const y = (i===0) ? botY + rand(-18,18) : topY + rand(-18,18); // i=0 => P1 bottom, i=1 => P2 top
      players.push({ id:i, isBot, alive:true, x: centerX + rand(-36,36), y, vx:0, vy:0, size:18, color: colors[i]||'#ccc', holding:false, speed:100 + Math.random()*80, name:`P${i+1}`, walkPhase:0 });
    }
  } else if(total === 4){
    const bl = {x:0.18*W, y:0.82*H}; // bottom-left -> P1
    const tl = {x:0.18*W, y:0.18*H}; // top-left -> P2
    const br = {x:0.82*W, y:0.82*H}; // bottom-right -> P3
    const tr = {x:0.82*W, y:0.18*H}; // top-right -> P4
    const positions = [bl, tl, br, tr]; // P1,P2,P3,P4
    for(let i=0;i<4;i++){
      const pos = positions[i];
      const isBot = (i >= humans);
      players.push({ id:i, isBot, alive:true, x: pos.x + rand(-24,24), y: pos.y + rand(-18,18), vx:0, vy:0, size:18, color: colors[i]||'#ccc', holding:false, speed:100 + Math.random()*80, name:`P${i+1}`, walkPhase:0 });
    }
  } else {
    // 3 players: P1 bottom-left, P2 top-center, P3 bottom-right
    const bl = {x:0.18*W, y:0.82*H};
    const tc = {x:0.5*W, y:0.18*H};
    const br = {x:0.82*W, y:0.82*H};
    const positions = [bl, tc, br];
    for(let i=0;i<3;i++){
      const pos = positions[i];
      const isBot = (i >= humans);
      players.push({ id:i, isBot, alive:true, x: pos.x + rand(-24,24), y: pos.y + rand(-18,18), vx:0, vy:0, size:18, color: colors[i]||'#ccc', holding:false, speed:100 + Math.random()*80, name:`P${i+1}`, walkPhase:0 });
    }
  }
  refreshLegend();
}

/* joystick class - same as before */
class Joystick {
  constructor(pid, cls){
    this.pid = pid;
    this.container = document.createElement('div');
    this.container.className = 'joystick ' + cls;
    this.base = document.createElement('div'); this.base.className = 'js-base';
    this.knob = document.createElement('div'); this.knob.className = 'js-knob';
    this.lbl = document.createElement('div'); this.lbl.className = 'playerLabel'; this.lbl.textContent = `P${pid+1}`;
    this.base.appendChild(this.knob); this.container.appendChild(this.base); this.container.appendChild(this.lbl);
    this.active=false; this.touchId=null; this.dx=0; this.dy=0; this.max=36;
    this.initEvents(); joystickLayer.appendChild(this.container); this.container.style.pointerEvents='auto';
  }
  initEvents(){
    this.base.addEventListener('touchstart', e=>{ e.preventDefault(); const t=e.changedTouches[0]; this.touchId=t.identifier; this.active=true; const pos=this.posFromTouch(t); this.moveKnob(pos.x,pos.y); }, {passive:false});
    window.addEventListener('touchmove', e=>{ if(!this.active) return; for(const t of e.changedTouches){ if(t.identifier===this.touchId){ const pos=this.posFromTouch(t); this.moveKnob(pos.x,pos.y); e.preventDefault(); break; } } }, {passive:false});
    window.addEventListener('touchend', e=>{ for(const t of e.changedTouches){ if(t.identifier===this.touchId){ this.reset(); break; } } }, {passive:false});
    // mouse fallback
    this.base.addEventListener('mousedown', e=>{ e.preventDefault(); this.active=true; this.mouseDown=true; const pos=this.posFromMouse(e); this.moveKnob(pos.x,pos.y); });
    window.addEventListener('mousemove', e=>{ if(!this.mouseDown) return; const pos=this.posFromMouse(e); this.moveKnob(pos.x,pos.y); });
    window.addEventListener('mouseup', e=>{ if(this.mouseDown) this.reset(); this.mouseDown=false; });
  }
  posFromTouch(t){ const r=this.base.getBoundingClientRect(); const cx=r.left+r.width/2, cy=r.top+r.height/2; return {x:t.clientX-cx, y:t.clientY-cy}; }
  posFromMouse(e){ const r=this.base.getBoundingClientRect(); const cx=r.left+r.width/2, cy=r.top+r.height/2; return {x:e.clientX-cx, y:e.clientY-cy}; }
  moveKnob(px,py){ const d=Math.hypot(px,py), max=this.max; let nx=px, ny=py; if(d>max){ const s=max/d; nx*=s; ny*=s; } this.knob.style.transform = `translate(${nx}px, ${ny}px)`; this.dx = nx / max; this.dy = ny / max; const dead = 0.12; if(Math.abs(this.dx) < dead) this.dx=0; if(Math.abs(this.dy) < dead) this.dy=0; }
  reset(){ this.active=false; this.touchId=null; this.knob.style.transform='translate(0,0)'; this.dx=0; this.dy=0; }
  destroy(){ if(this.container.parentNode) this.container.parentNode.removeChild(this.container); }
}

const JOY_POS = ['js-bl','js-br','js-tl','js-tr'];
function createJoysticks(humans){
  joystickLayer.innerHTML=''; joysticks = [];
  if(humans === 2 && totalPlayers >= 2){
    const j1 = new Joystick(0, 'js-bottomcenter'); const j2 = new Joystick(1, 'js-topcenter');
    joysticks.push(j1, j2);
  } else {
    for(let i=0;i<humans;i++){
      const cls = JOY_POS[i] || JOY_POS[0];
      const j = new Joystick(i, cls); joysticks.push(j);
    }
  }
}

/* bomb & projectiles */
let bombRemainingOnTransfer = 0;
function giveBombRandom(minDur,maxDur){
  const alive = players.filter(p=>p.alive);
  if(alive.length === 0){ bomb = null; return; }
  const chosen = alive[Math.floor(Math.random()*alive.length)];
  players.forEach(p=>p.holding=false);
  chosen.holding = true;
  const sec = Math.max(2, Math.floor(rand(minDur,maxDur)));
  bomb = { holderId: chosen.id, explodeAt: Date.now()+sec*1000, duration: sec, active:true, inFlight:false };
  setStatus(`Bom ke ${chosen.name} ‚Äî ${sec}s`);
  showMsg(`${chosen.name} memegang bom ‚Äî ${sec}s`, 1400);
}
function transferBombAnimated(fromId,toId){
  const from = players.find(p=>p.id===fromId), to = players.find(p=>p.id===toId);
  if(!from || !to || !from.holding || !to.alive || fromId===toId) return;
  from.holding = false; bomb.inFlight = true; bomb.active = false;
  bombRemainingOnTransfer = Math.max(120, bomb.explodeAt - Date.now());
  const travel = 220 + Math.random()*160;
  projectiles.push({ sx: from.x, sy: from.y, tx: to.x, ty: to.y, x: from.x, y: from.y, t0: Date.now(), travel, color: from.color, toId });
  playWhoosh();
  showMsg(`Bom dilempar: ${from.name} ‚Üí ${to.name}`, 1200);
}
function explodeAt(id){
  const p = players.find(x=>x.id===id); if(!p) return;
  p.alive=false; p.holding=false;
  createExplosion(p.x,p.y,p.color); playExplosion(); setStatus(`üí• ${p.name} meledak!`);
  projectiles = projectiles.filter(pr => pr.toId !== id);
  setTimeout(()=>{ const alive = players.filter(pp=>pp.alive); if(alive.length <= 1) endGame(); else giveBombRandom(parseInt(minDurEl.value,10), parseInt(maxDurEl.value,10)); }, 900);
}
function createExplosion(x,y,color){ particles=[]; for(let i=0;i<34;i++){ particles.push({ x,y, vx: rand(-3.2,3.2), vy: rand(-4,2), life: rand(500,1400), born: Date.now(), color }); } }

/* AI */
function botBehavior(p, dt){
  if(!p.alive) return;
  const bomber = players.find(pp => pp.holding && pp.alive);
  if(p.holding){
    const targets = players.filter(pp => pp.alive && pp.id !== p.id);
    if(targets.length === 0) return;
    let best = targets[0], bd = dist(p,best);
    for(const t of targets){ const d = dist(p,t); if(d < bd){ bd = d; best = t; } }
    const desired = { x: best.x - p.x, y: best.y - p.y }; const m = Math.hypot(desired.x,desired.y) || 1;
    p.vx = (desired.x / m) * p.speed; p.vy = (desired.y / m) * p.speed;
  } else {
    if(bomber && bomber.id !== p.id){
      const desired = { x: p.x - bomber.x, y: p.y - bomber.y }; const m = Math.hypot(desired.x,desired.y) || 1;
      p.vx = (desired.x / m) * p.speed; p.vy = (desired.y / m) * p.speed;
      p.vx += rand(-20,20); p.vy += rand(-20,20);
    } else {
      if(Math.random() < 0.02){ p.vx = rand(-50,50); p.vy = rand(-50,50); }
      p.vx *= 0.96; p.vy *= 0.96;
    }
  }
}

/* update/draw with animation */
let stepSoundTimer = 0;
function update(dt){
  for(let i=0;i<players.length;i++){
    const p = players[i];
    if(!p.alive) continue;
    if(!p.isBot){
      const js = joysticks.find(j => j.pid === p.id) || joysticks[p.id];
      if(js){ p.vx = js.dx * p.speed; p.vy = js.dy * p.speed; } else { p.vx *= 0.9; p.vy *= 0.9; }
    } else botBehavior(p, dt);

    const speed = Math.hypot(p.vx, p.vy);
    if(speed > 20){
      p.walkPhase += dt * (speed / 60);
      stepSoundTimer += dt;
      if(stepSoundTimer > 0.28){ stepSoundTimer = 0; if(soundEnabled) playBeep(900, 0.03, 'sine'); }
    } else p.walkPhase += dt * 0.2;
  }
  players.forEach(p=>{
    if(!p.alive) return;
    p.x += p.vx * dt; p.y += p.vy * dt;
    const pad = 36 * (canvas.width/800);
    if(p.x < pad) p.x = pad; if(p.y < pad) p.y = pad;
    if(p.x > canvas.width - pad) p.x = canvas.width - pad;
    if(p.y > canvas.height - pad) p.y = canvas.height - pad;
  });

  const nowt = Date.now();
  for(let i=projectiles.length-1;i>=0;i--){
    const pr = projectiles[i];
    const t = (nowt - pr.t0)/pr.travel;
    if(t >= 1){
      const toPlayer = players.find(x=>x.id===pr.toId);
      projectiles.splice(i,1);
      if(toPlayer && toPlayer.alive){
        toPlayer.holding = true;
        const rem = Math.max(120, bombRemainingOnTransfer);
        bomb = { holderId: toPlayer.id, explodeAt: Date.now() + rem, duration: Math.max(1, Math.floor(rem/1000)), active:true, inFlight:false };
        playBeep(900,0.06,'square'); setStatus(`Bom sekarang di ${toPlayer.name}`);
      } else giveBombRandom(parseInt(minDurEl.value,10), parseInt(maxDurEl.value,10));
    } else {
      pr.x = pr.sx + (pr.tx - pr.sx) * easeOutCubic(t);
      pr.y = pr.sy + (pr.ty - pr.sy) * easeOutCubic(t);
    }
  }

  if(bomb && bomb.active){
    const holder = players.find(p=>p.id===bomb.holderId);
    if(!holder || !holder.alive) giveBombRandom(parseInt(minDurEl.value,10), parseInt(maxDurEl.value,10));
    else {
      for(const p of players){
        if(!p.alive) continue; if(p.id===holder.id) continue;
        const d = dist(holder,p);
        if(d < (holder.size + p.size) * 0.85){ transferBombAnimated(holder.id, p.id); break; }
      }
      if(Date.now() >= bomb.explodeAt){ explodeAt(holder.id); bomb.active = false; }
    }
  }

  particles = particles.filter(pt=>{
    const lifeLeft = pt.life - (Date.now() - pt.born);
    if(lifeLeft <= 0) return false;
    pt.x += pt.vx * dt * 120; pt.y += pt.vy * dt * 120; pt.vy += 0.06; return true;
  });

  players.forEach(p=>{ if(!p.alive) return; if(p.isBot && Math.random() < 0.02){ p.vx += rand(-20,20); p.vy += rand(-20,20); } });

  refreshLegend();
}

function draw(){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  ctx.save(); ctx.globalAlpha = 0.04; ctx.fillStyle = '#fff';
  const step = Math.floor(40 * (canvas.width/800));
  for(let gx=0; gx < canvas.width; gx += step){ ctx.fillRect(gx,0,1,canvas.height); }
  for(let gy=0; gy < canvas.height; gy += step){ ctx.fillRect(0,gy,canvas.width,1); }
  ctx.restore();

  players.forEach(p=>{
    if(!p.alive){ ctx.save(); ctx.globalAlpha = 0.16; drawStickmanAnim(p.x,p.y,p.size,'#666',false, p.walkPhase, p.y < canvas.height/2); ctx.restore(); return; }
    const faceDown = (p.y < canvas.height/2); // top -> true => faces down; bottom -> false => faces up
    drawStickmanAnim(p.x,p.y,p.size,p.color,p.holding, p.walkPhase, faceDown);
    // name label on canvas (so DOM menu won't overlap it)
    ctx.font = `${14 * (canvas.width/800)}px system-ui`; ctx.fillStyle='#e8fbff'; ctx.textAlign='center';
    ctx.fillText(`${p.isBot ? 'B' : ''}${p.name}`, p.x, p.y - p.size - 14);
  });

  projectiles.forEach(pr=>{ drawBomb(pr.x, pr.y, Math.max(8,12*(canvas.width/800))); });

  if(bomb && bomb.active){
    const holder = players.find(p=>p.id===bomb.holderId && p.alive);
    if(holder){
      drawBomb(holder.x + holder.size + 12, holder.y - holder.size/2, Math.max(8,12*(canvas.width/800)));
      const remain = Math.max(0, Math.ceil((bomb.explodeAt - Date.now())/1000));
      ctx.font = `${16 * (canvas.width/800)}px monospace`; ctx.fillStyle='#fff';
      ctx.textAlign='center';
      ctx.fillText(`${remain}s`, holder.x + holder.size + 12, holder.y - holder.size - 18);
      const ratio = Math.max(0.22, Math.min(1,(bomb.explodeAt - Date.now())/(bomb.duration*1000)));
      ctx.beginPath(); ctx.arc(holder.x, holder.y, holder.size + 18 * ratio, 0, Math.PI*2);
      ctx.strokeStyle = `rgba(255,80,80,${0.25 + (1-ratio)*0.7})`; ctx.lineWidth = 3; ctx.stroke();
    }
  }

  particles.forEach(pt=>{
    const life = Math.max(0, (pt.life - (Date.now()-pt.born)));
    const alpha = Math.max(0.06, Math.min(1, life/1600));
    ctx.globalAlpha = alpha; ctx.beginPath(); ctx.fillStyle = pt.color; ctx.arc(pt.x, pt.y, 4 * (canvas.width/800), 0, Math.PI*2); ctx.fill(); ctx.globalAlpha = 1;
  });

  // HUD alive
  const alive = players.filter(p=>p.alive).length;
  ctx.font = `${12 * (canvas.width/800)}px system-ui`;
  ctx.fillStyle = '#cfe8ff'; ctx.textAlign = 'left';
  ctx.fillText(`Alive: ${alive}`, 12 * (canvas.width/800), 18 * (canvas.width/800));
}

/* procedural stickman animation */
function drawStickmanAnim(x,y,size,color, highlight=false, walkPhase=0, faceDown=true){
  ctx.save();
  ctx.lineWidth = Math.max(2, size/6);
  ctx.beginPath(); ctx.fillStyle = color; ctx.strokeStyle = '#001214'; ctx.arc(x, y - size*0.9, size*0.7, 0, Math.PI*2); ctx.fill(); ctx.stroke();
  ctx.beginPath(); ctx.strokeStyle = color; ctx.moveTo(x, y - size*0.2); ctx.lineTo(x, y + size*1.2); ctx.stroke();
  const armSwing = Math.sin(walkPhase * Math.PI * 2) * (size*0.18);
  ctx.beginPath(); 
  // if faceDown true (player on top looking down): arms drawn normally; if faceUp (bottom), flip vertical position slightly
  const armY = y + size*0.0 + (faceDown ? 0 : -6 * (size/18));
  ctx.moveTo(x - size*1.05, armY + armSwing); ctx.lineTo(x + size*1.05, armY - armSwing); ctx.stroke();
  // legs
  const legAmt = Math.sin(walkPhase * Math.PI * 2) * (size*0.35);
  ctx.beginPath(); ctx.moveTo(x, y + size*1.2); ctx.lineTo(x - size*0.9, y + size*2.0 + legAmt); ctx.moveTo(x, y + size*1.2); ctx.lineTo(x + size*0.9, y + size*2.0 - legAmt); ctx.stroke();
  // eyes adjust to facing
  ctx.beginPath(); ctx.fillStyle = '#001214';
  if(faceDown){
    ctx.arc(x - size*0.18, y - size*0.75, Math.max(1.4, size*0.09), 0, Math.PI*2);
    ctx.arc(x + size*0.18, y - size*0.75, Math.max(1.4, size*0.09), 0, Math.PI*2);
  } else {
    ctx.arc(x - size*0.18, y - size*1.0, Math.max(1.4, size*0.09), 0, Math.PI*2);
    ctx.arc(x + size*0.18, y - size*1.0, Math.max(1.4, size*0.09), 0, Math.PI*2);
  }
  ctx.fill();
  if(highlight){ ctx.beginPath(); ctx.lineWidth = Math.max(2,size/8); ctx.strokeStyle = 'rgba(255,220,80,0.9)'; ctx.arc(x,y,size*1.8,0,Math.PI*2); ctx.stroke(); }
  ctx.restore();
}
function drawBomb(x,y,r){ ctx.save(); ctx.beginPath(); ctx.fillStyle = '#111'; ctx.strokeStyle = '#222'; ctx.arc(x,y,r,0,Math.PI*2); ctx.fill(); ctx.lineWidth = Math.max(2, r/6); ctx.strokeStyle = '#bf2b2b'; ctx.stroke(); ctx.beginPath(); ctx.moveTo(x - r*0.6, y - r*0.6); ctx.lineTo(x - r*1.6, y - r*1.6); ctx.strokeStyle = '#ffd86b'; ctx.lineWidth = Math.max(2, r/5); ctx.stroke(); ctx.beginPath(); ctx.fillStyle = '#fff3b8'; ctx.arc(x - r*1.6, y - r*1.6, Math.max(2, r/4), 0, Math.PI*2); ctx.fill(); ctx.restore(); }

/* loop */
let lastFrame = performance.now();
function loop(t){
  const dt = Math.min(40, t - lastFrame)/1000; lastFrame = t;
  if(running) update(dt);
  draw();
  requestAnimationFrame(loop);
}
requestAnimationFrame(loop);

/* UI & menu wiring */
function setStatus(msg, timeout=1800){
  statusEl.textContent = msg;
  if(timeout>0){
    setTimeout(()=>{ if(running){ const alive = players.filter(p=>p.alive).length; statusEl.textContent = `Game berjalan ‚Äî Pemain hidup: ${alive}`; } }, timeout);
  }
}
function refreshLegend(){
  // keep legend DOM small; does not overlap canvas labels (canvas labels drawn above players)
  legendDiv.innerHTML = '';
  players.forEach(p=>{
    const row = document.createElement('div'); row.style.marginBottom='6px';
    const sw = document.createElement('span'); sw.className='sw'; sw.style.background = p.color;
    const txt = document.createElement('span'); txt.innerHTML = `<strong style="margin-right:6px">${p.isBot ? 'Bot' : ''}${p.name}</strong>${p.holding ? ' ‚Äî BOM' : ''}${p.alive ? '' : ' (mati)'}`;
    row.appendChild(sw); row.appendChild(txt); legendDiv.appendChild(row);
  });
}
function openMenu(){ menu.classList.add('open'); overlay.classList.add('show'); menu.setAttribute('aria-hidden','false'); }
function closeMenu(){ menu.classList.remove('open'); overlay.classList.remove('show'); menu.setAttribute('aria-hidden','true'); }
hamb.addEventListener('click', ()=> { if(menu.classList.contains('open')) closeMenu(); else openMenu(); });
overlay.addEventListener('click', ()=> closeMenu());
openLeader.addEventListener('click', ()=> { renderUnderboard(); openMenu(); });
closeMenuBtn.addEventListener('click', ()=> { closeMenu(); });

function applyAndStart(){
  if(audioCtx.state === 'suspended') audioCtx.resume();
  totalPlayers = parseInt(totalPlayersEl.value,10);
  humanPlayers = Math.min(totalPlayers, parseInt(humanPlayersEl.value,10));
  if(humanPlayers < 1) humanPlayers = 1;
  if(humanPlayers > totalPlayers) humanPlayers = totalPlayers;
  const minD = Math.max(2, parseInt(minDurEl.value,10) || 40);
  const maxD = Math.max(minD+1, parseInt(maxDurEl.value,10) || 80);
  saveSettings({ totalPlayers, humanPlayers, minDur: minD, maxDur: maxD, mode: modeSelect.value, soundEnabled });
  spawnPlayers(totalPlayers, humanPlayers);
  createJoysticks(humanPlayers);
  projectiles = []; particles = []; running = true;
  giveBombRandom(minD, maxD);
  setStatus('Game dimulai ‚Äî selamat bermain!', 2000);
  backToMenu.style.display = '';
}

/* drag touch movement (drag player) */
let dragging = {active:false, pid:null, offx:0, offy:0};
canvas.addEventListener('touchstart', e=>{
  const t = e.touches[0];
  const rect = canvas.getBoundingClientRect();
  const tx = (t.clientX - rect.left) * (canvas.width/rect.width);
  const ty = (t.clientY - rect.top) * (canvas.height/rect.height);
  for(const p of players){
    if(!p.alive) continue;
    if(Math.hypot(tx - p.x, ty - p.y) < p.size * 2.2){
      dragging.active = true; dragging.pid = p.id; dragging.offx = p.x - tx; dragging.offy = p.y - ty; break;
    }
  }
});
canvas.addEventListener('touchmove', e=>{
  if(!dragging.active) return;
  const t = e.touches[0];
  const rect = canvas.getBoundingClientRect();
  const tx = (t.clientX - rect.left) * (canvas.width/rect.width);
  const ty = (t.clientY - rect.top) * (canvas.height/rect.height);
  const p = players.find(x=>x.id===dragging.pid);
  if(p && p.alive){ p.x = tx + dragging.offx; p.y = ty + dragging.offy; p.vx=0; p.vy=0; }
});
canvas.addEventListener('touchend', e=>{ dragging.active=false; dragging.pid=null; });

/* ensure bomb exists */
setInterval(()=>{
  if(!running) return;
  if(bomb && bomb.active){
    const holder = players.find(p=>p.id===bomb.holderId);
    if(!holder || !holder.alive) giveBombRandom(parseInt(minDurEl.value,10), parseInt(maxDurEl.value,10));
  } else if(bomb && bomb.inFlight){} else if(!bomb){
    const alive = players.filter(p=>p.alive);
    if(alive.length > 1) giveBombRandom(parseInt(minDurEl.value,10), parseInt(maxDurEl.value,10));
  }
}, 700);
setInterval(()=>{ if(!running) return; players.forEach(p=>{ if(!p.alive) return; if(p.isBot && Math.random() < 0.02){ p.vx += rand(-20,20); p.vy += rand(-20,20); } }); }, 1200);

/* leaderboard */
function addWin(name){
  const lb = loadLB();
  const found = lb.find(r=>r.name === name);
  if(found) found.wins += 1; else lb.push({ name, wins: 1, last: new Date().toISOString() });
  lb.sort((a,b)=> b.wins - a.wins || a.name.localeCompare(b.name));
  saveLB(lb); renderUnderboard();
}
function renderUnderboard(){
  const lb = loadLB();
  if(lb.length === 0){ underList.innerHTML = '<div class="small">Belum ada pemenang</div>'; return; }
  let html = '';
  for(const r of lb.slice(0,6)){ html += `<div class="lbRow"><div style="width:28px;height:18px;background:rgba(255,255,255,0.03);border-radius:4px;display:flex;align-items:center;justify-content:center;color:var(--muted);margin-right:8px;">${r.wins}</div><div><div class="lbName">${r.name}</div></div></div>`; }
  underList.innerHTML = html;
}
resetLB.addEventListener('click', ()=>{ localStorage.removeItem(LB_KEY); renderUnderboard(); });

/* end game */
function endGame(){
  running = false;
  backToMenu.style.display = '';
  const alive = players.filter(p=>p.alive);
  if(alive.length === 1){
    const winner = alive[0];
    setStatus(`üèÜ ${winner.name} MENANG!`, 6000);
    let name = winner.name;
    try{
      const n = prompt(`Pemenang: ${winner.name}\nMasukkan nama untuk leaderboard (kosong = ${winner.name})`);
      if(n !== null && n.trim() !== '') name = n.trim();
    }catch(e){}
    addWin(name);
  } else setStatus('Game selesai.', 3000);
  renderUnderboard();
}

/* msg bubble */
let msgTimeout = null;
function showMsg(text, ms=1200){
  msgBubble.textContent = text; msgBubble.style.display='block';
  if(msgTimeout) clearTimeout(msgTimeout);
  msgTimeout = setTimeout(()=>{ msgBubble.style.display='none'; msgTimeout = null; }, ms);
}

/* init: load settings and spawn */
(function init(){
  const s = loadSettings();
  if(s){
    if(s.totalPlayers) totalPlayersEl.value = s.totalPlayers;
    if(s.humanPlayers) humanPlayersEl.value = s.humanPlayers;
    if(s.minDur) minDurEl.value = s.minDur;
    if(s.maxDur) maxDurEl.value = s.maxDur;
    if(s.mode) modeSelect.value = s.mode;
    if(typeof s.soundEnabled === 'boolean'){ soundEnabled = s.soundEnabled; setSoundUI(); }
  }
  totalPlayers = parseInt(totalPlayersEl.value,10);
  humanPlayers = Math.min(totalPlayers, parseInt(humanPlayersEl.value,10));
  spawnPlayers(totalPlayers, humanPlayers);
  createJoysticks(humanPlayers);
  renderUnderboard();
  setStatus('Siap ‚Äî buka menu ‚ò∞ lalu Start');
})();

/* expose start */
startBtn.addEventListener('click', ()=> { applyAndStart(); closeMenu(); });
applyBtn.addEventListener('click', ()=> { applyAndStart(); closeMenu(); });

</script>
</body>
</html>